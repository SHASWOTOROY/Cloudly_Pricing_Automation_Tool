pipeline {
  agent {
    docker {
      image 'php:8.1-cli'
      args '-u root'
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  environment {
    COMPOSER_ALLOW_SUPERUSER = '1'
  }

  stages {
    stage('Checkout') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Install Dependencies') {
      steps {
        sh '''
          set -e
          if [ -f composer.json ]; then
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            php composer-setup.php --install-dir=/usr/local/bin --filename=composer
            rm composer-setup.php
            composer install --no-interaction --prefer-dist
          else
            echo "No composer.json found, skipping composer install."
          fi
        '''
      }
    }

    stage('Lint') {
      steps {
        sh '''
          set -e
          PHP_FILES=$(find . -type f -name "*.php")
          if [ -n "$PHP_FILES" ]; then
            for f in $PHP_FILES; do php -l "$f"; done
          else
            echo "No PHP files to lint."
          fi
        '''
      }
    }

    stage('Test') {
      steps {
        sh '''
          set -e
          if [ -f phpunit.xml ] || [ -d tests ]; then
            if command -v vendor/bin/phpunit >/dev/null 2>&1; then
              vendor/bin/phpunit --colors=always
            else
              echo "PHPUnit not installed; install via composer require --dev phpunit/phpunit"
              exit 1
            fi
          else
            echo "No tests found; skipping."
          fi
        '''
      }
    }

    stage('Package') {
      steps {
        sh '''
          set -e
          mkdir -p build
          tar -czf build/cloudly.tar.gz \
            --exclude='./.git' \
            --exclude='./build' \
            .
        '''
      }
    }

    stage('Archive') {
      steps {
        archiveArtifacts artifacts: 'build/cloudly.tar.gz', fingerprint: true
      }
    }
  }

  post {
    always {
      sh 'rm -rf build || true'
      cleanWs()
    }
  }
}
